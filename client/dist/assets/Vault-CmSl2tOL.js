import{c as oe,r,af as H,j as e,C as de,h as ce,i as ue,ag as xe,k as he,B as i,q as ge,I as d,D,m as O,n as R,o as T,E,ah as pe,ai as me,aj as je,ak as fe,al as ve,am as we}from"./index-DESoNwQK.js";import{T as Ce}from"./textarea-1YYYT-yv.js";const Ne=oe("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]);function Se({token:n,externalParties:P}){const[g,p]=r.useState([]),[I,L]=r.useState(!1),[c,W]=r.useState(""),[m,_]=r.useState("all"),[j,K]=r.useState("all"),[l,G]=r.useState(null),[J,f]=r.useState(!1),[Q,h]=r.useState(!1),[v,V]=r.useState("create"),[N,b]=r.useState(!1),[X,y]=r.useState(""),[A,Z]=r.useState(null),[F,$]=r.useState(null),[ee,w]=r.useState(!1),[k,z]=r.useState(""),[S,Y]=r.useState(null),[B,u]=r.useState(null),[t,o]=r.useState({id:"",title:"",username:"",password:"",url:"",notes:"",tags:"",externalOwnerId:"",rotationPeriodDays:""}),se=r.useMemo(()=>{const s=new Set;return g.forEach(a=>a.tags.forEach(x=>s.add(x))),Array.from(s)},[g]),M=r.useMemo(()=>g.filter(s=>{const a=!c||s.title.toLowerCase().includes(c.toLowerCase())||s.username.toLowerCase().includes(c.toLowerCase())||(s.url??"").toLowerCase().includes(c.toLowerCase())||s.tags.some(ie=>ie.toLowerCase().includes(c.toLowerCase())),x=m==="all"||s.tags.includes(m),le=j==="all"||s.externalOwnerId===j;return a&&x&&le}),[g,c,m,j]),q=s=>{if(!s.rotationPeriodDays||!s.lastRotatedAt)return null;const a=new Date(s.lastRotatedAt.getTime()+s.rotationPeriodDays*24*60*60*1e3);return Date.now()>a.getTime()?"Rotação vencida":null};r.useEffect(()=>{n&&(L(!0),H(n).then(s=>p(s)).catch(()=>p([])).finally(()=>L(!1)))},[n]),r.useEffect(()=>{if(!N)return;A&&window.clearTimeout(A);const s=window.setTimeout(()=>{b(!1),y("")},15e3);return Z(s),()=>window.clearTimeout(s)},[N]);function U(){n&&H(n).then(s=>p(s)).catch(()=>p([]))}function ae(){V("create"),o({id:"",title:"",username:"",password:"",url:"",notes:"",tags:"",externalOwnerId:"",rotationPeriodDays:""}),h(!0)}function re(s){V("edit"),o({id:s.id,title:s.title,username:s.username,password:"",url:s.url??"",notes:s.notes??"",tags:s.tags.join(", "),externalOwnerId:s.externalOwnerId??"",rotationPeriodDays:s.rotationPeriodDays?String(s.rotationPeriodDays):""}),h(!0)}async function te(s){if(!n)return;const a=await ve(n,s.id);G(a),b(!1),y(""),f(!0)}function ne(){return F?Date.now()-F>300*1e3:!0}async function C(s,a){if(!n)return;if(ne()){Y({type:s,id:a}),w(!0);return}const x=await we(n,a,s==="COPY"?"COPY_SECRET":"VIEW_SECRET");s==="COPY"?(await navigator.clipboard.writeText(x.password),u("Senha copiada com sucesso.")):(y(x.password),b(!0))}return e.jsxs("div",{className:"grid gap-6",children:[e.jsxs(de,{className:"bg-card/70",children:[e.jsxs(ce,{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{children:[e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-primary"}),"Cofre de Senhas"]}),e.jsx(he,{children:"Credenciais críticas protegidas com criptografia."})]}),e.jsx(i,{onClick:ae,children:"Novo registro"})]}),e.jsxs(ge,{className:"space-y-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"grid gap-3 lg:grid-cols-3",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-md border border-input bg-transparent px-3",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(d,{value:c,onChange:s=>W(s.target.value),placeholder:"Buscar por título, login, URL ou tag",className:"border-0 px-0 focus-visible:ring-0"})]}),e.jsxs("select",{className:"h-10 rounded-md border border-input bg-transparent px-3 text-sm",value:m,onChange:s=>_(s.target.value),children:[e.jsx("option",{value:"all",children:"Todas as tags"}),se.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("select",{className:"h-10 rounded-md border border-input bg-transparent px-3 text-sm",value:j,onChange:s=>K(s.target.value),children:[e.jsx("option",{value:"all",children:"Todos os responsáveis"}),P.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),I?e.jsx("p",{children:"Carregando..."}):null,!I&&M.length===0?e.jsx("p",{children:"Nenhum registro encontrado."}):null,e.jsx("div",{className:"grid gap-3",children:M.map(s=>e.jsxs("div",{className:"rounded-lg border border-border/60 bg-background/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:s.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.username})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.tags.map(a=>e.jsx("span",{className:"rounded-full border border-border/60 bg-background/40 px-2 py-0.5 text-xs",children:a},a))})]}),e.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[s.url?e.jsx("p",{children:s.url}):null,s.rotationPeriodDays?e.jsxs("p",{children:["Rotação: ",s.rotationPeriodDays," dias"]}):null,q(s)?e.jsx("p",{className:"text-amber-300",children:q(s)}):null]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx(i,{size:"sm",variant:"outline",onClick:()=>te(s),children:"Detalhes"}),e.jsx(i,{size:"sm",variant:"outline",onClick:()=>C("COPY",s.id),children:"Copiar senha"})]})]},s.id))})]})]}),e.jsx(D,{open:J,onOpenChange:f,children:e.jsxs(O,{className:"max-w-2xl",children:[e.jsx(R,{children:e.jsx(T,{children:"Detalhes do registro"})}),l?e.jsxs("div",{className:"grid gap-3 text-sm text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase text-muted-foreground",children:"Título"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:l.title})]}),e.jsxs("div",{className:"grid gap-2 lg:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase text-muted-foreground",children:"Login"}),e.jsx("p",{children:l.username}),e.jsx(i,{size:"sm",variant:"outline",className:"mt-2",onClick:async()=>{await navigator.clipboard.writeText(l.username),u("Login copiado com sucesso.")},children:"Copiar login"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase text-muted-foreground",children:"URL"}),e.jsx("p",{children:l.url??"-"})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase text-muted-foreground",children:"Notas"}),e.jsx("p",{children:l.notes??"-"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:l.tags.map(s=>e.jsx("span",{className:"rounded-full border border-border/60 bg-background/40 px-2 py-0.5 text-xs",children:s},s))}),e.jsxs("div",{className:"rounded-md border border-border/60 bg-background/40 p-3",children:[e.jsx("p",{className:"text-xs uppercase text-muted-foreground",children:"Senha"}),e.jsx("p",{className:"text-base font-semibold text-foreground",children:N?X:"••••••••"}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsx(i,{size:"sm",variant:"outline",onClick:()=>C("VIEW",l.id),children:"Revelar por 15s"}),e.jsx(i,{size:"sm",variant:"outline",onClick:()=>C("COPY",l.id),children:"Copiar senha"})]})]})]}):null,e.jsxs(E,{className:"flex flex-wrap justify-between gap-2",children:[e.jsx(i,{variant:"destructive",onClick:async()=>{!n||!l||(await pe(n,l.id),f(!1),u("Registro removido."),U())},children:"Excluir"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(i,{variant:"outline",onClick:()=>{l&&re(l)},children:"Editar"}),e.jsx(i,{variant:"secondary",onClick:()=>f(!1),children:"Fechar"})]})]})]})}),e.jsx(D,{open:Q,onOpenChange:h,children:e.jsxs(O,{className:"max-w-2xl",children:[e.jsx(R,{children:e.jsx(T,{children:v==="create"?"Novo registro":"Editar registro"})}),e.jsxs("div",{className:"grid gap-3 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"Título *"}),e.jsx(d,{value:t.title,onChange:s=>o(a=>({...a,title:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"Login *"}),e.jsx(d,{value:t.username,onChange:s=>o(a=>({...a,username:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsxs("label",{children:["Senha ",v==="edit"?"(opcional)":"*"]}),e.jsx(d,{type:"password",value:t.password,onChange:s=>o(a=>({...a,password:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"URL"}),e.jsx(d,{value:t.url,onChange:s=>o(a=>({...a,url:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"Notas"}),e.jsx(Ce,{value:t.notes,onChange:s=>o(a=>({...a,notes:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"Tags (separadas por vírgula)"}),e.jsx(d,{value:t.tags,onChange:s=>o(a=>({...a,tags:s.target.value}))})]}),e.jsxs("div",{className:"grid gap-3 lg:grid-cols-2",children:[e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"Responsável externo"}),e.jsxs("select",{className:"h-10 rounded-md border border-input bg-transparent px-3 text-sm",value:t.externalOwnerId,onChange:s=>o(a=>({...a,externalOwnerId:s.target.value})),children:[e.jsx("option",{value:"",children:"Não definido"}),P.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"grid gap-1",children:[e.jsx("label",{children:"Rotação (dias)"}),e.jsx(d,{type:"number",value:t.rotationPeriodDays,onChange:s=>o(a=>({...a,rotationPeriodDays:s.target.value}))})]})]})]}),e.jsxs(E,{children:[e.jsx(i,{variant:"secondary",onClick:()=>h(!1),children:"Cancelar"}),e.jsx(i,{onClick:async()=>{if(n){if(!t.title||!t.username||v==="create"&&!t.password){u("Preencha os campos obrigatórios.");return}try{const s={title:t.title,username:t.username,password:t.password||void 0,url:t.url||void 0,notes:t.notes||"",tags:t.tags.split(",").map(a=>a.trim()).filter(Boolean),externalOwnerId:t.externalOwnerId||void 0,rotationPeriodDays:t.rotationPeriodDays?Number(t.rotationPeriodDays):void 0};v==="create"?await me(n,s):await je(n,t.id,s),h(!1),u("Registro salvo."),U()}catch(s){u(s?.message??"Falha ao salvar registro.")}}},children:"Salvar"})]})]})}),e.jsx(D,{open:ee,onOpenChange:w,children:e.jsxs(O,{className:"max-w-md",children:[e.jsx(R,{children:e.jsx(T,{children:"Reautenticação necessária"})}),e.jsxs("div",{className:"grid gap-2 text-sm text-muted-foreground",children:[e.jsx("p",{children:"Digite sua senha para continuar."}),e.jsx(d,{type:"password",value:k,onChange:s=>z(s.target.value)})]}),e.jsxs(E,{children:[e.jsx(i,{variant:"secondary",onClick:()=>w(!1),children:"Cancelar"}),e.jsx(i,{onClick:async()=>{if(n)try{await fe(n,k),$(Date.now()),z(""),w(!1),S&&(C(S.type,S.id),Y(null))}catch(s){u(s?.message??"Senha inválida.")}},children:"Confirmar"})]})]})}),B?e.jsx("p",{className:"text-sm text-muted-foreground",children:B}):null]})}export{Se as Vault};
